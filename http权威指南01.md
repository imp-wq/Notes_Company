# HTTP权威指南 01

## 一、XXXX

* MIME类型：Multipurpose Internet Mail Extension，多用于因特网邮件扩展，来源于邮件系统，用于标记多媒体内容。
  * web服务器会为所有HTTP对象数据附加一个MIME类型，当浏览器从服务器取回一个对象时，会查看MIME类型，以此得知如何处理这个对象。
  * MIME组成：`主要对象类型/特定子类型`
    * HTML：text/html
    * ASCII文本：text/plain
    * JPEG图片：image/jpeg
    * GIF图片：image/gif
    * ...

* 每个web服务器资源有一个名字，用Uniform Resource Identifier,URI来标识。

  URI有2中形式：URL和URN，现在几乎所有URI都是URL。

  * URL：
    * scheme：方案，即协议类型
    * 服务器地址
    * 服务器的资源

  * URN：作为特定唯一名称使用，与资源目前的所在地无关，比如用于internet标准文档等。目前处于实验阶段。

* 事务：
  * 一个HTTP事务由一条请求和一个响应组成，通过格式化的数据HTTP 报文(message)进行。
  * HTTP method：常见的由GET PUT DELETE POST HEAD。
  * 状态码

* 报文：http报文由字符串组成，是纯文本而不是二进制代码，因此方便读写。

  报文包含3个部分：

  * 起始行
  * 首部字段：以`:`分隔的key-value，以一个空行结束。
  * 主体：起始行和首部都是文本且结构化的，而主体可以包含任何如二进制等格式的数据。

* TCP/IP：

  * TCP/IP为http提供了：

    * 无差错数据传输

    * 按序传输

    * 未分段数据流，允许任意时刻数据以任意尺寸发送。

  * HTTP发送报文之前，需要先根据URL，在服务器和客户端之间建立TCP/IP连接。

    * 通过URL，得知服务器的IP地址，和特定软件的TCP端口号。
    * http默认端口号80
    * IP地址可以通过DNS由域名转换得到。

<img src="D:\wzy\Note\noteimages\http权威指南-http通信过程.PNG" style="zoom:50%;" />

### telnet

​	telnet程序基于http，可以将键盘连接到某个目标tcp端口，并将该端口的输出会送到显示屏。

* telnet可以模拟http客户端，但不能作为服务器使用。
* netcat功能类似，但是更加灵活。

### http协议版本

* 0.9:http原型版本，存在很多严重缺陷，只能获取简单HTML对象，只有GET方法，没有MIME类型、HTTP首部等
* 1.0：第一个广泛使用的HTTP版本，添加了版本号，HTTP首部、多媒体对象的处理，可以包含图片和交互式表格。
* 1.0+：很多流行的web客户端和服务器都在向http添加特性，形成的非官方的事实标准统称为1.0+
* 1.1：是当前使用的http版本，校正http结构性缺陷，明确语义，性能优化。
* 2.0：又名HTTP-NG。

### web结构组件

​	除了浏览器和服务器，还有很多重要的web应用程序：

* 代理：客户端和服务器见的http中间实体。

  * 代理在转发时，可以对请求和响应进行过滤。

* 缓存：web cache/proxy cache，http仓库，保存常用页面副本。

  * ​      console.log('12312332')是一种特殊的http代理服务器，可以保存代理传送的常用文档。

* 网关：一种特殊服务器，常用于将http流量转换成其他协议。

  * 比如HTTP/FTP网关可以将FTP协议获取的文档封装成http报文发给客户端。

* 隧道：对http报文进行盲转发的特殊代理，转发时不会窥探数据。

  * 常见应用：通过http连接，建立加密的SSL(Secure Sockets Layer)连接。我理解是将SSL流量通过隧道封装成HTTP流量。

* 用户agent代理：能代表用户发起http请求的客户端程序。

  * 比如浏览器、spiders。
  * 我理解所谓的“客户端”就是agent代理。

  

## 二、URL与资源

* url #号后为片段
* 相对URL：类似相对路径
  * ./表示当前基础url
  * HTML可以通过`<BASE>`标记基础URL。
* URL自动扩展：
  * 主机名扩展
  * 历史扩展
* URL编码
  * 为什么要有URL编码：
    * 让URL可移植portable，一些协议，比如Simple Mail Transfer Protocol，会剥去一些特定字符，因此URL需要使用通用的字符。
    * 转义序列：使用US-ASCII的子集对任意字符进行编码。
  
  * 最好对URL中所有不安全的字符进行编码，使其成为可以在各应用之间共享的规范形式。

* URN：URL表示的是实际地址，因此如果资源位置发生了改变，就无法通过原先的URL进行定位。URN是为资源定一个稳定的名称，无论对象搬到什么地方都不改变。

  PURL（persistent uniform resource locators）是URN的一个实现，在搜索资源过程中加入一个中间层，通过一个中间resource locator服务器对实际url进行登记和跟踪。

## 三、http报文

* 基本概念：
  * 事务transaction
  * 流入inbound：报文从客户端流入服务器。
  * 流出outbound：报文从服务器流出到用户的agent代理。
  * 报文会从上游upstream发送者流向下游downstream接收者。
  * 行终止序列CRLF：一个回车符加(ASCII 13)一个换行符(ASCII 10)。
  
* 报文的组成：
  * start line
  
  * header
  
    * 首部总应该以一个空行结束，即单个的CRLF。
  
    * http版本号：`HTTP/<major>.<minor>`
  
      数字应该分开进行比较，比如2.22比2.3版本新，因为次版本号22比3大。
  
  * body

* http 0.9：

  * 请求只包含方法和url，响应只有实体。

  * 没有版本信息，因为当时只有唯一一个版本。

    没有首部、reason phrase和状态码。

### 方法

* 安全方法：使用安全方法请求之后，服务器不会产生什么动作（比如信用卡支付等）。
  * 安全方法可以用来通知用户，什么动作会引发不安全方法。
  * GET和HEAD方法属于安全方法。
* GET方法常用于请求服务器发送某个资源。
* HEAD方法只响应首部，不返回实体，用于客户端对首部进行检查：
  * 比如判断资源类型。
  * 查看响应码，判断对象是否存在。
* HEAD方法返回的首部必须与GET方法的完全相同。
* PUT方法用于向服务器写入文档，比如让用户创建web页面。
  * put方法的语义是让服务器用request body部分来创建一个由request url命名的新文档。如果url已存在，则用request body将其替换。
  * 因为put方法允许用户修改内容，所以往往需要登录后操作。

* POST方法用于像服务器输入数据，比如HTML表单。

* TRACE方法：TRACE请求用于发起一个环回诊断。服务器在弹回的TRACE响应body中携带收到的原始请求报文，以便客户端查看请求穿过防火墙、代理、网关时遭到了哪些修改。

  * 但TRACE请求无法监测针对不同请求类型进行不同处理的情况。中间应用程序会自行决定如果处理TRACE请求。
  * trace请求不能有body，响应的body为服务器收到请求的精确副本。

* OPTIONS方法用于请求服务器告知其支持的各种功能，比如支持的方法等。

  为客户端提供一种手段，不必访问资源就能判定访问各类资源的最优方式。

* DELETE方法用于请求服务器删除URL指定的资源，但允许服务器在不通知客户端的情况下撤销请求。

* 扩展方法：http字段可扩展，没有在http1.1规范中规定的方法为扩展方法。

### 状态码

* 1xx：100 Continue可看成一种优化，在客户端像服务器发送一个大实体之前，先询问服务器能否接收，服务器可以用100响应表示可以接收。
* 2xx：成功
* 3xx：重定向
  * 可以发送一个重定向状态码和一个可选的Location首部来告知客户端资源已被移走，以便浏览器透明的转到新位置。
  * 可用于将本地副本与服务端资源进行验证，查看本地资源是否为最新。
    * 比如客户端发送一个携带`If-Modified-Since:资源日期`的首部，如果文档并未修改，可以返回一个304状态码，表示将资源重定向到本地副本。
  * 一些状态码：
    * 300 Multiple Choices：同时返回一个URL选项列表，允许客户端进行选择。可以用于选择同一个文档的不同语言版本。Location首部包含首选url。
    * 301 Moved Permanently：location首部包含资源现在所处url。
    * 302 Found：location首部给出资源所处的临时url，将来请求仍使用老的url。
    * 304 Not Modified：客户端可以通过请求首部字段，使其请求变成有条件的。这个响应码的响应不应有主体部分。
    * 305 Use Proxy：客户端需要通过一个代理来访问资源，location首部给出代理的url。
  * HTTP/1.0使用302 Found表示临时重定向，HTTP/1.1使用307 Temporary Redirect表示临时重定向。
    * 4xx
    * 5xx

### 首部

​	首部和方法共同决定客户端和服务器能做什么事情。

* 分类：

  * 通用首部：客户端和服务器都可以用的。
  
    比如Date，请求和响应都可以用于说明构建报文的日期。
  
  * 请求首部

    比如`Accept: */*`，表示客户端接受与其请求相符的任何类型。
  
  * 响应首部
  
    比如通过Server字段告知客户端服务器的版本。
  
  * 实体首部：用于应对实体主体部分的首部，比如Content-Type用于说明实体部分的数据类型。
  
  * 扩展首部
  
* 通用首部：

  不论报文是什么类型，都表达相同的意思。比如Date，不论是请求还是响应，创建报文的时间都是同一个意思。

  * 通用缓存首部：HTTP/1.0开始允许HTTP app缓存对象的首部。

    比如Cache-Control：用于指示随报文传送缓存。

* 请求首部：

  只在请求报文中有意义的首部。

  * Accept首部：Accpet让客户端将其能力告知服务端，一面服务器发送客户端无法处理的内容造成时间和带宽浪费。

    * Accept：告知服务器能发送哪些媒体类型
    * Accept-Charset：字符集
    * Accept-Encoding：编码方式
    * Accept-Language
    * TE：扩展传输编码

  * 条件请求首部：为请求加上某些限制，要求服务器确定条件为真，再进行响应。

    * Except：允许客户端列出请求所要求服务器的行为。
    * If-Modified-Since：资源在某个指定日期后被修改过，否则限制这个请求。
    * If-None-Match：如果提供的实体标记与当前文档的实体标记不符，则获取文档。
    * If-Range：允许对文档的某个范围进行请求。

  * 安全请求首部：HTTP提供一种简单的机制，可以对请求进行质询/响应认证。

    * Authorization：包含客户端提供给服务器用于对客户端进行认证的数据。

    * Cookie：客户端向服务器传送一个令牌。

      并不是真正的安全首部，但隐含了安全的功能。

  * 代理请求首部：用于代理的。

* 响应首部：响应首部为客户端提供一些额外信息。

  * 信息性首部：
    * Age：响应持续时间。
    * Public：服务器为资源支持的请求方式列表。

  * 协商首部：与客户端对资源进行协商，比如发送哪种语言的资源。

    * Accept-Ranges：对于该资源，服务器接受的范围类型。

  * 安全响应首部：HTTP质询/响应机制的响应侧。

    * www-Authenticate：服务器对客户端的质询列表。

    * Set-Cookie：服务器对客户端设置令牌，以进行标识。

      不是真正的安全首部但隐含安全功能。

* 实体首部：用于描述HTTP报文的负荷。因为请求和响应报文中都可能包含实体，因此都可能包含实体首部。

  * 信息性首部：

    

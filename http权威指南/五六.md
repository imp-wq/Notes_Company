## 五、web服务器

​	Web服务器实现了HTTP和相关的TCP连接处理。

* Web服务器逻辑和OS共同负责管理TCP连接，OS负责：
  * 管理底层硬件细节
  * 提供TCP/IP网络支持，装载Web资源文件系统
  * 控制计算活动的进程管理

* web服务器会做些什么：

  1. 建立连接
  2. 接收请求
  3. 处理请求
  4. 访问资源
  5. 构建响应
  6. 发送响应
  7. 记录事务处理过程：将已完成事务的有关内容记录到日志文件中。


### 一、接收客户端连接

* 如果客户端已经打开了一条持久连接，可以通过其发送请求。否则会打开一条新连接。
* 一旦新连接建立并被服务器接受，服务器会将其跳到现存Web服务器连接列表中，以便监视连接上的数据传输。
* 反向DNS：将客户端IP地址转换成主机名。
* ident协议

### 二、接收请求报文

* 连接上有数据到达时，服务器会从连接中读出数据，并解析出请求报文。
* 解析请求报文：
  * 查找请求方法、URI、版本号、报文首部等信息。
  * 根据首部Content-Length读取请求主体。

### 三、处理请求

### 四、对资源的映射及访问

* 将请求报文的中URI映射为Web服务器上的内容。

* docroot：即document root，根目录，专门存放web内容的目录。

* 服务器不能让相对URL退到docroot之外，使文件系统其余部分暴露。

* 虚拟托管的docroot：在同一台web server上托管多个站点。

  * 每个站点有自己的docroot。
  * 可以通过HTTP的Host首部、或根据不同IP来区分不同站点。

* 动态内容资源的映射：执行服务器目录中的程序。

  Java servlet就属于动态资源映射的应用程序。

### 五、构建响应

​	识别出资源后，server执行请求方法中描述的动作，并返回响应报文。

* 有响应主体的话，响应报文应包含：

  * Content-Type首部：描述主体的MIME类型。
  * Content-Length首部：描述主体长度。
  * 主体内容。


* MIME类型：web server负责确定响应主体的MIME类型。
  * 可以通过资源的文件扩展名，通过一个保存所有扩展名和MIME类型的文件，来确定资源的MIME类型。
  * magic typing：web server扫描所有文件，与一个已知模式表（魔法文件）进行匹配，来决定文件MIME类型。比较慢，但在文件没有标准扩展名时比较方便。
  * explicit typing：提前配置web server的某个文件或目录拥有某个MIME类型。
  * 类型协商：与客户端协商使用哪种格式。
* 重定向

### 六、发送响应

### 七、记录日志



## 六、代理

​	没有web代理，client直接与server对话，有了web代理，client与proxy进行对话，由proxy代表client与server交流。

​	proxy既是web server又是web client。

* 代理和网关：
  * 代理：连接2个或多个使用相同协议的应用程序。
  * 网关：连接2个或多个使用不同协议的端点。即“协议转换器”。
  * 实际上网关和代理的区别很模糊，比如在browser和server使用不同版本的HTTP时，代理也会进行一些协议转换工作。

### 代理的作用

​	代理可以看到并接触所有流过的HTTP流量，可以监视流量并对其进行修改。

* 儿童过滤器
* 文档访问控制
* 安全防火墙
* web缓存
* 反向代理surrogate/reverse proxy：代理假扮web服务器，接收发给server的请求，可以与其他server通信，以便按需定位请求的内容。
  * 可用于提高访问慢速web server时的性能，server accelerator。
* 转码器
* 匿名者：代理将报文首部中计算机与OS类型、E-mail、Cookie等关键信息删除。

#### 代理的部署位置

​	代理可以部署在任意位置，根据其用途决定。

* 出口代理：防火墙，过滤内容。
* 入口（访问）代理：缓存代理。
* 反向代理：在web服务器之前，处理传送给web服务器的请求。
* 网络交换代理：放对等交换点上。

#### 代理的层次结构

proxy hierarchy。更靠近服务器的代理层级结构越高，是父代理。

* 代理的层次结构可能是动态的，即动态选择父代理：
  * 负载均衡
  * 根据地理位置选择

#### 代理如何获取流量

* 客户端手动配置。

* 通过网络基础设施在client不知情情况下拦截网络流量导入代理。

  拦截intercepting代理。

* 修改DNS：常用于反向代理，假扮web server的名字和IP。

* 由服务器重定向：server 向client发一条响应码为305的HTTP重定向命令，定向到代理。


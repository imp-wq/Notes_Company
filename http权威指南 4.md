## 四、连接管理

### TCP/IP连接

* 一旦TCP/IP连接建立，服务器和客户端之间交换的报文就永远不会丢失、受损或失序。

* 浏览器从接收到url起：

  1. 解析主机名

  2. 查询主机名对应的IP，DNS解析。

  3. 获取端口号

  4. 浏览器发起到目标服务器端口的连接。

  5. 发送请求报文

  6. 读取响应报文

  7. 浏览器关闭连接

     <img src="D:\wzy\Note\noteimages\浏览器运行过程.PNG" style="zoom:50%;" />

* TCP连接：

  * HTTP连接实际上就是TCP连接和一些使用规则。

  * TCP为HTTP提供了一条可靠的bit传输管道，一端填入的字节会从另一端以原有顺序、正确的传送出来。

  * TCP数据通过IP分组（IP数据报）的小数据块发送的。

  * HTTP位于`HTTP over TCP over IP`协议栈的最顶层。

    HTTPS则是再HTTP与TCP之间加入了一个TLS或SSL密码加密层。

  * HTTP传输报文时，会以流的形式将报文内容通过一条打开的TCP连接按序传输。TCP会将数据流砍成小数据块（TCP段），并将其封装到IP分组中，通过网络进行传输。该过程由TCP/IP软件处理，对于HTTP程序员透明。

  * 每个TCP段由IP分组承载，从一个IP地址发送到另一个IP地址。每个IP分组包括：

    * IP分组首部，20 bytes。

      包含源和目的IP地址、长度和一些其他标记。

    * TCP段首部，20 bytes。

      包含TCP端口号、TCP控制标记、用于数据排序和完整性检查的值。

    * TCP数据块，任意字节。

    <img src="D:\wzy\Note\noteimages\HTTP和HTTPS协议栈.PNG" style="zoom:50%;" />

* TCP端口号：

  * TCP连接通过4个值来唯一的识别一条连接：源IP地址 源端口号 目的IP地址 目的端口号。

    可以有多个连接共用一个源端口/目的端口，但不能有2个连接这4个值完全一致。

* TCP Socket：Socket是OS提供的操纵TCP连接的API，向HTTP程序员隐藏了TCP/IP的所有细节（比如底层网络协议握手细节，IP分组对TCP数据流的分段重装细节等）。

  所有OS和语言都会有Socket或其变体。

  套接字的作用：

  * 允许用户创建TCP端点数据结构，与服务器的TCP端点进行连接。
  * 以数据流的形式进行读写。

  这些作用均可在java的socket中得到充分体现。